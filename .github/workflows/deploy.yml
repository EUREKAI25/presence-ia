name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Permet de déclencher manuellement depuis GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no root@212.227.80.241 << 'EOF'
            set -e
            cd /opt/presence-ia
            git pull origin main
            # Installer uniquement les nouveaux packages (évite les conflits avec packages Debian)
            pip3 install -q --break-system-packages "libsass>=0.23.0" "pillow>=10.0.0"
            pip3 install -q --break-system-packages --no-deps \
              -e ./libs/theme_composer \
              -e ./libs/theme_generator \
              -e ./libs/page_builder
            systemctl restart presence-ia
            sleep 3
            echo "=== STATUS ==="
            systemctl status presence-ia --no-pager | head -20
            echo "=== LOGS (30 dernières lignes) ==="
            journalctl -u presence-ia -n 30 --no-pager
            echo "✅ Déploiement terminé"
          EOF
        timeout-minutes: 5

      - name: Deployment success
        if: success()
        run: echo "✅ Déploiement réussi sur presence-ia.com"

      - name: Deployment failed
        if: failure()
        run: echo "❌ Échec du déploiement - vérifier SSH"
